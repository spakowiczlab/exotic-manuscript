---
title: "PCAs for batch effects"
author: "Rebecca Hoyd"
date: "2/9/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
```

# Load data

```{r}
drakedir <- "/fs/ess/PAS1695/projects/exotic/data/drake-output/2022-02-16/"

# tcc.batchres <- readRDS(file.path(drakedir, "tcc.batchres.RDS"))
# tcga.batchres <- readRDS(file.path(drakedir, "tcga.batchres.RDS"))

tcc.counts <- readRDS(file.path(drakedir, "tcc.counts.RDS"))
tcga.counts <- readRDS(file.path(drakedir, "tcga.counts.RDS"))

tcc.norm <- readRDS(file.path(drakedir, "tcc.exora.RDS"))
tcga.norm <-readRDS(file.path(drakedir, "tcga.exora.RDS"))

tcga.meta <- readRDS(file.path(drakedir, "tcga.meta.RDS"))
tcc.meta <- readRDS(file.path(drakedir, "tcc.meta.linkage.RDS"))
```

# PCAs

## Format

```{r}
counts.lowvar <- unlist(lapply(tcga.counts[,-1], function(x) var(x)))
summary(counts.lowvar)
counts.higvar <- names(subset(counts.lowvar, counts.lowvar > 0))


```

```{r}
tcga.counts.pc <- tcga.counts %>%
  select(c("sample", counts.higvar)) %>%
  column_to_rownames(var = "sample") 

counts.res  <- prcomp(tcga.counts.pc, scale. = T)$x %>%
  as.data.frame() %>%
  rownames_to_column(var = "sample") %>%
  select(sample, PC1, PC2) %>%
  mutate(datset = "counts")

tcga.norm.pc <- tcga.norm %>%
  column_to_rownames(var = "sample") 

norm.res  <- prcomp(tcga.norm.pc, scale. = T)$x%>%
  as.data.frame() %>%
  rownames_to_column(var = "sample") %>%
  select(sample, PC1, PC2) %>%
  mutate(datset = "normalized")
```

## Plot

```{r}
pcs.res <- bind_rows(counts.res, norm.res) %>%
  left_join(tcga.meta)

pcs.res %>%
  ggplot(aes(x = PC1, y = PC2, color = ffpe.status, fill = ffpe.status)) +
  facet_wrap(vars(datset), scales = "free") +
  geom_point(alpha = .4) +
  stat_ellipse(geom = "polygon", alpha = .2) +
  scale_fill_viridis_d(aesthetics = c("color", "fill")) +
  theme_bw()
ggsave("../figures/pca_compare-FFPE.png")
```

# What are those groups?

```{r}
pcs.grouplab <- pcs.res %>%
  filter(datset == "normalized") %>%
  mutate(pc.group = ifelse(PC1 < -200, "ClusterA",
                           ifelse(PC1 < -60, "ClusterB",
                                  ifelse(PC2 > 200, "Outlier",
                                         "main.group"))))

pcs.grouplab %>% 
  group_by(pc.group, tissue_source_site) %>%
  tally()
```

```{r}
pcs.res %>%
  ggplot(aes(x = PC1, y = PC2, color = tissue_source_site, fill = tissue_source_site)) +
  facet_wrap(vars(datset), scales = "free") +
  geom_point(alpha = .4, show.legend = F) +
  stat_ellipse(geom = "polygon", alpha = .2, show.legend = F) +
  scale_fill_viridis_d(aesthetics = c("color", "fill")) +
  theme_bw()
```

# Volcano

```{r}

```


