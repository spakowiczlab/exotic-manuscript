---
title: "Visualize correlations"
author: "Rebecca Hoyd"
date: "3/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(viridis)

library(vegan)
library(ggdendro)
```

# Load data

```{r}
tcc.all <- read.csv("/fs/ess/PAS1695/projects/exotic/data/correlations_mic-immune_TCC.csv",
                    stringsAsFactors = F)
tcc.split <- read.csv("/fs/ess/PAS1695/projects/exotic/data/correlations_mic-immune_TCC_split-cancer.csv",
                      stringsAsFactors = F)
tcga.all <- read.csv("/fs/ess/PAS1695/projects/exotic/data/correlations_mic-immune_TCGA.csv",
                     stringsAsFactors = F)
tcga.split <- read.csv("/fs/ess/PAS1695/projects/exotic/data/correlations_mic-immune_TCGA_split-cancer.csv",
                       stringsAsFactors = F)
```

# Format

```{r}
tcc.res <- tcc.all %>%
  mutate(cancer = "All") %>%
  bind_rows(tcc.split)

tcga.res <- tcga.all %>%
  mutate(cancer = "All") %>%
  bind_rows(tcga.split)

corr.res <- bind_rows(tcc.res, tcga.res)
```

```{r}
matched.cancers <- unique(subset(corr.res, corr.res$datset == "TCGA")$cancer)
corr.res.red <- corr.res %>%
  filter(cancer %in% matched.cancers) %>%
  group_by(microbe) %>%
  mutate(choosemic = any(p.value < 0.05)) %>%
  ungroup() %>%
  filter(choosemic == T & grepl("^g", microbe)) %>%
  mutate(datset = ifelse(datset == "TCGA", "TCGA", "ORIEN"))
```

# Plots 

```{r}
plotScoreCorr <- function(dsource){
  micord <- corr.res.red %>%
    filter(datset == dsource & cancer == "All") %>%
    dplyr::select(microbe, estimate, ImmuneCell) %>%
    pivot_wider(names_from = ImmuneCell, values_from = estimate,
                values_fill = NA) %>%
    column_to_rownames(var = "microbe") %>%
    as.matrix() %>%
    dist() %>%
    hclust() %>%
    dendro_data()
  micord <- micord$labels$label
  p <- corr.res.red %>%
    filter(datset == dsource) %>%
    mutate(TaxLev = str_sub(microbe, 1, 1)) %>%
    ggplot(aes(x = fct_relevel(microbe, micord), y = ImmuneCell, fill = estimate)) +
    facet_wrap(vars(cancer), scales = "free_x", nrow = 1) +
    geom_tile() +
    labs(x = "", y = "") +
    scale_fill_viridis_c(option = "mako", name = "Correlation Estimate",
                         limits = c(-1,1)) +
    theme_classic() +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank())
  
  return(p)
}
```

```{r}
plotScoreCorr("TCGA")
ggsave("../figures/heatmap_corr_mic-immune_TCGA.pdf")
```

```{r}
plotScoreCorr("ORIEN")
ggsave("../figures/heatmap_corr_mic-immune_ORIEN.pdf")
```


