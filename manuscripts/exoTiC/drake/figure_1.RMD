---
title: "Figure 1 panels"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyr)
library(ggplot2)
```

# Access starting targets

```{r}
# Counts, before any manipulation
loadd(raw.tcc.counts)
loadd(raw.tcga.counts)

# Counts, removing samples that fail to resolve batches (missing info, etc.)
loadd(tcc.batchres)
loadd(tcga.batchres)

#Counts,after removing contaminants and all microbes not found in TCGA
# loadd(tcc.counts)
# loadd(tcga.counts)

#Contaminants found in each of the groups
loadd(tcc.contams)
loadd(tcga.contams)

loadd(contaminant.details)
# Final counts with taxonomy
# loadd(tcc.exora.taxonomy)
# loadd(tcga.exora.taxonomy)
```

# 1A - Portion of reads excluded at each step

Steps: start with raw counts. Remove the samples that don't have information required for batches used in decontam, or are in too small batches for decontam to handle. Use decontam to identify contaminant, then adjust by including Poore et. al. blacklist and whitelist information. Contaminants are combined between TCGA and TCC.
```{r}
#Start: sum all raw counts
tcc.startcount = sum(colSums(raw.tcc.counts[, -1]))
tcga.startcount = sum(colSums(raw.tcga.counts[, -1]))

#How many lost when batches fixed?
tcc.batchcount <- sum(colSums(tcc.batchres$counts[,-1]))
tcga.batchcount <- sum(colSums(tcga.batchres$counts[,-1]))
# Need to split up the contaminant phase, I think

## Remove decontam found contaminants
tcc.rem.decontam <- tcc.batchres$counts %>%
  select(-any_of(contaminant.details$decontam.contaminants$microbe))
tcga.rem.decontam <- tcga.batchres$counts %>%
  select(-any_of(contaminant.details$decontam.contaminants$microbe))

tcc.rem.decontam.count <- sum(colSums(tcc.rem.decontam[,-1], na.rm = T))
tcga.rem.decontam.count <- sum(colSums(tcga.rem.decontam[,-1], na.rm = T))
## After the inclusion of the blacklist (additions and subtractions)
tcc.rem.salter <- tcc.batchres$counts %>%
    tidyr::gather(-sample, key = "microbe", value = "counts") %>%
    dplyr::filter(!microbe %in% contaminant.details$decontam.remove.salter$microbe) %>%
    tidyr::separate(microbe, into = c("Genera"), remove = F, sep = "\\.") %>%
    dplyr::filter(!Genera %in% contaminant.details$salter.likely.contaminants) %>%
    dplyr::select(-Genera) %>%
    spread(key = "microbe", value = "counts")
tcga.rem.salter <- tcga.batchres$counts %>%
    tidyr::gather(-sample, key = "microbe", value = "counts") %>%
    dplyr::filter(!microbe %in% contaminant.details$decontam.remove.salter$microbe) %>%
    tidyr::separate(microbe, into = c("Genera"), remove = F, sep = "\\.") %>%
    dplyr::filter(!Genera %in% contaminant.details$salter.likely.contaminants) %>%
    dplyr::select(-Genera) %>%
    spread(key = "microbe", value = "counts")

good.mics <- colnames(tcga.rem.salter)

tcc.rem.salter.count <- sum(colSums(tcc.rem.salter[,-1], na.rm = T))
tcga.rem.salter.count <- sum(colSums(tcga.rem.salter[,-1], na.rm = T))
# Remove microbes only found in TCC
tcc.finprep <- tcc.rem.salter %>%
  select(any_of(good.mics))
tcc.fincount <- sum(colSums(tcc.finprep[,-1]))
tcga.fincount <- sum(colSums(tcga.rem.salter[,-1]))
```

```{r get waterfall counts into ggplotable df}
waterfall.df <- as.data.frame(cbind(step = c("start", "batch resolution", "initial decontam",
                                             "literature altered decontam", "Remove TCC only"),
                                    tcc = c(tcc.startcount, tcc.batchcount, tcc.rem.decontam.count,
                                            tcc.rem.salter.count, tcc.fincount),
                                    tcga = c(tcga.startcount, tcga.batchcount, tcga.rem.decontam.count,
                                             tcga.rem.salter.count, tcga.fincount)))
  # 


ymin.tcc <- c(54700000000, waterfall.df$tcc[1:4])
ymin.tcga <- c(178000000000, waterfall.df$tcga[1:4])

waterfall.df <- waterfall.df %>%
  tidyr::gather(-step, key = "Data.Source", value = "count")
waterfall.df$y.min <- c(ymin.tcc, ymin.tcga)
```

## Waterfall format
```{r}
waterfall.df %>%
  mutate(id = rep(1:5, 2),
         y.min = as.numeric(y.min),
         count = as.numeric(count),
         changedir = ifelse(y.min < count, "Gain", "Loss"),
         Data.Source = toupper(Data.Source)) %>%
  ggplot() +
  geom_rect(aes(ymin = y.min, ymax = count, xmin = id - .45 ,
            xmax = id + .45, x = id, fill = changedir)) +
  scale_fill_manual(breaks = c("Gain", "Loss"), values = c("darkgreen", "darkred"), 
                    name = "Effect on\nread count") +
  facet_wrap(vars(Data.Source), scales = "free_y") +
  labs(x = "") +
  theme_bw() +
  ggsave("../figures/1A_waterfall-plot.png")
```

## Barplot format

```{r}
waterfall.df %>%
  mutate(id = rep(1:5, 2),
         y.min = as.numeric(y.min),
         count = as.numeric(count)) %>%
  ggplot(aes(x = id, y = count)) +
  geom_col() +
  facet_wrap(vars(Data.Source), scales = "free_y")
```

# 1B - Density plots of common laboratory contaminants

```{r}
# Grab counts limited to good batch matches (counts that decontam acted on)
tcga.batchres.counts <- tcga.batchres$counts
tcc.batchres.counts <- tcc.batchres$counts


```

## Plot contaminant densities

```{r}
# Grab some contaminant names. I want the contaminants that most look like contaminants to decontam, without being evaluated as probably existing in the samples as fact by subsequent literature review.

most.likely.contams <- contaminant.details$decontam.remove.salter %>%
  arrange(p)

most.likely.contams <- most.likely.contams$microbe[1:5]

# Get chosen contaminants ready for plotting
allcounts.for.density <- bind_rows(tcc.batchres.counts, tcga.batchres.counts) %>%
  select("sample", all_of(most.likely.contams)) %>%
  mutate(Data.Source = ifelse(grepl("^SL", sample), "TCC", "TCGA")) %>%
  gather(-sample, -Data.Source, key = "microbe", value = "counts")
```

```{r}
allcounts.for.density %>%
  ggplot(aes(x = counts, color = Data.Source)) +
  facet_wrap(vars(microbe), scales = "free", nrow = 1) +
  geom_density() +
  scale_color_manual(breaks = c("TCC", "TCGA"), values = c("orange", "black")) +
  labs(x = "", y = "") +
  theme_bw() +
  ggsave("../figures/1B_contaminant-densities.png", width = 12, height = 4.5)
```
## Plot suspicious densities

```{r}
suspicious.taxa <- c("Abelson.murine.leukemia.virus", "Proteus.phage.VB_PmiS.Isfahan", 
                     "Pseudomonas.resinovorans")

suspicious.for.density <- bind_rows(tcc.batchres.counts, tcga.batchres.counts) %>%
  select("sample", all_of(suspicious.taxa)) %>%
  mutate(Data.Source = ifelse(grepl("^SL", sample), "TCC", "TCGA")) %>%
  gather(-sample, -Data.Source, key = "microbe", value = "counts")

suspicious.for.density %>%
  ggplot(aes(x = counts, color = Data.Source)) +
  facet_wrap(vars(microbe), scales = "free", nrow = 1) +
  geom_density() +
  scale_color_manual(breaks = c("TCC", "TCGA"), values = c("orange", "black")) +
  labs(x = "", y = "") +
  theme_bw() +
  ggsave("../figures/1B_suspicious-densities.png", width = 10, height = 4.5)
```

# 1C - Check enrichment in various groupings
