---
title: "Correlations with taxa, TILs and gene expression"
author: "Daniel Spakowicz"
date: "12/9/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(RColorBrewer)
library(ggplot2)
library(forcats)
library(broom)
```

```{r exogenous sequences relative abundances}
exo.tax <- read.csv("../data/agg_exo-ra_taxonomy.csv", stringsAsFactors = FALSE)
key <- read.csv("../data/exotcc_deidentified-ids.csv", stringsAsFactors = FALSE) %>%
  rename("sample" = "id")
imcells <- read.csv("../data/split-deconvolved-aggcuff_absolute/2019-12-09_cibersort_absolute_aggregated+TILS.csv",
                    stringsAsFactors = FALSE)
```


# Stacked bar at Phylum level

## All data
```{r}
exo.gi.phyl <- exo.tax %>%
  left_join(key) %>%
  filter(cancer == "GI") %>%
  mutate(phylum = ifelse(spec.join == "Proteus.phage.VB_PmiS.Isfahan", "Proteus phage", phylum)) %>%
  group_by(sample, phylum) %>%
  summarise(phylum.ra = sum(ra, na.rm = TRUE))

phyls <- unique(exo.gi.phyl$phylum)
phyl.count <- length(phyls)
getPal <- colorRampPalette(brewer.pal(8, "Dark2"))

getord <- exo.gi.phyl %>%
  group_by(phylum) %>%
  summarise(Mean = mean(phylum.ra, na.rm = TRUE)) %>%
  arrange(Mean)
```

```{r}
exo.gi.phyl %>%
  ggplot(aes(x = sample, y = phylum.ra, fill = fct_relevel(phylum, rev(getord$phylum)))) +
  geom_col() +
  scale_fill_manual(breaks = phyls, values = getPal(phyl.count), na.value = "grey", name = "Phylum") +
  labs(x = "", y = "Relative Abundance") +
  theme_bw() +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
  ggsave("../figures/gi_stacked-bar.png")
```
This graph is getting messed up by a few species that 


# Heatmap of phyla correlations to TIL's

## Calculate correlations

```{r}
int.cells <- c("T.cells.CD8", "NK.cells.resting", "NK.cells.activated", "T.cells.regulatory..Tregs.", "Neutrophils")
phyls <- ifelse(is.na(phyls), "<NA>", phyls)
imcells.gi <- imcells %>%
  filter(cancer == "GI") %>%
  select(Input.Sample, int.cells)

exo.gi.imphyl <- exo.gi.phyl %>%
  spread(key = "phylum", value = "phylum.ra") %>%
  rename("Input.Sample" = "sample") %>%
  left_join(imcells.gi)
```

```{r}
cor.res <- list()
cor.res.cell <- list()
for(p in phyls){
  for(i in int.cells){
    cor.res.cell[[i]] <- cor.test(as.numeric(exo.gi.imphyl[[p]]), as.numeric(exo.gi.imphyl[[i]]), 
                                  method = "spearman") %>%
      tidy() %>%
      select(estimate, p.value) %>%
      mutate(cell = i, phylum = p)
  }
  cor.res[[p]] <- cor.res.cell
}
```

```{r}
cor.df <- bind_rows(lapply(cor.res, function(x) bind_rows(x)))
```

## Build heatmap

```{r}
cor.df %>%
  mutate(dir = ifelse(estimate < 0, "neg", "pos")) %>%
  ggplot(aes(x = cell, y = phylum, fill = p.value, shape = dir)) +
  geom_tile() +
  geom_point(size = 3) +
  scale_fill_distiller(guide = "legend", breaks = c(0.00001, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.2, 0.5, 1), 
                       limits = c(0, 1), values = c(0.00001, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.2, 0.5, 1),
                       type = "div", palette = "BrBG", direction = 1, 
                       labels = c("<0.01", "0.01", "0.02","0.03", "0.04","0.05","0.1", "0.2", "0.5", "1"),
                       name = "P.value") +
  scale_shape_manual(breaks = c("neg", "pos"), labels = c("Negative", "Positive"), values = c("-", "+"),
                     name = "Correlation direction") +
  labs(x = "", y = "") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust = 1, angle = 45)) +
  ggsave("../figures/gi_corr-pvalue-heatmap.png", width = 5, height = 8)
```



