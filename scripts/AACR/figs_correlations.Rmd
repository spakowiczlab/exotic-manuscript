---
title: "figures_correlations"
author: "Rebecca Hoyd"
date: "February 6, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(dplyr)
library(tidyr)
library(broom)
```

# Load data
```{r}
exo.ra <- read.csv("../../data/agg_exo-ra_taxonomy.csv", stringsAsFactors = F)
immunecells <- read.csv("../../data/split-deconvolved-aggcuff_absolute/2019-12-09_cibersort_absolute_aggregated+TILS.csv", stringsAsFactors = F) %>%
  select(cancer, everything()) %>%
  rename("sample" = "Input.Sample")

```


```{r}
exo.ra.gen <- exo.ra %>%
  group_by(sample, genus) %>%
  summarise(ra = sum(ra)) %>%
  spread(key = "genus", value = "ra")

exo.ra.gen[is.na(exo.ra.gen)] <- 0
```
# Test correlations
```{r}
microbes <- colnames(exo.ra.gen)[-1]
imcells <- colnames(immunecells)[-c(1:3)]
cancers <- unique(immunecells$cancer)

micim <- exo.ra.gen %>%
  left_join(immunecells)
```
```{r}
# cor.can <- list()
# for(c in cancers){
#   micim.tmp <- micim %>%
#     filter(cancer == c)
#   
#   cor.can[[c]] <- lapply(microbes, function(m) lapply(imcells, function(i) cor.test(micim.tmp[[m]], micim.tmp[[i]],
#                                                                     method = "spearman") %>%
#                                         tidy() %>%
#                                         mutate(im.cell = i, microbe = m, cancer = c))) 
#   
#   
# }
# 
# test <- lapply(cor.can, function(x) lapply(x, function (y) bind_rows(y)))
# test <- lapply(test, function(x) bind_rows(x))
# cor.can <- bind_rows(test)
# 
# write.csv(cor.can, "../../data/AACR_correlations.csv", row.names = F)

cor.can <- read.csv("../../data/AACR_correlations.csv")
```