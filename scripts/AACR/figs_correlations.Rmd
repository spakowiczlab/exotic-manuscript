---
title: "figures_correlations"
author: "Rebecca Hoyd"
date: "February 6, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(dplyr)
library(tidyr)
library(broom)
```

# Load data
```{r}
exo.ra <- read.csv("../../data/agg_exo-ra_taxonomy.csv", stringsAsFactors = F)
immunecells <- read.csv("../../data/split-deconvolved-aggcuff_absolute/2019-12-09_cibersort_absolute_aggregated+TILS.csv", stringsAsFactors = F) %>%
  select(cancer, everything()) %>%
  rename("sample" = "Input.Sample")

```


```{r}
exo.ra.gen <- exo.ra %>%
  group_by(sample, genus) %>%
  summarise(ra = sum(ra)) %>%
  spread(key = "genus", value = "ra")

exo.ra.gen[is.na(exo.ra.gen)] <- 0
```

```{r}
oldlabs <- c("B.cells.naive", "B.cells.memory", 
             "Plasma.cells", "T.cells.CD8", "T.cells.CD4.naive", 
             "T.cells.CD4.memory.resting", "T.cells.CD4.memory.activated", "T.cells.follicular.helper",
             "T.cells.gamma.delta", "T.cells.regulatory..Tregs.", "NK.cells.resting", 
             "NK.cells.activated", "Monocytes", "Macrophages.M0", 
             "Macrophages.M1", "Macrophages.M2", "Dendritic.cells.resting", 
             "Dendritic.cells.activated", "Mast.cells.resting", "Mast.cells.activated", 
             "Eosinophils", "Neutrophils", "TILs")

newlabs <- c("Naive B Cells", "Memory B Cells", 
             "Plasma Cells", "CD8 T Cells", "Naive CD4 T Cells", 
             "Resting Memory CD4 T Cells", "Activated Memory CD4 T Cells", "Follicular Helper T Cells",
             "Gamma Delta T Cells", "Regulatory T Cells", "Resting NK Cells", 
             "Activated NK Cells", "Monocytes", "M0 Macrophages",
             "M1 Macrophages", "M2 Macrophages", "Resting Dendritic Cells", 
             "Activated Dendritic Cells", "Resting Mast Cells", "Activated Mast Cells", 
             "Eosonophils", "Neutrophils", "TILs")


```

# Test correlations
```{r}
microbes <- colnames(exo.ra.gen)[-1]
imcells <- colnames(immunecells)[-c(1:3)]
cancers <- unique(immunecells$cancer)

micim <- exo.ra.gen %>%
  left_join(immunecells)
```
```{r}
# cor.can <- list()
# for(c in cancers){
#   micim.tmp <- micim %>%
#     filter(cancer == c)
#   
#   cor.can[[c]] <- lapply(microbes, function(m) lapply(imcells, function(i) cor.test(micim.tmp[[m]], micim.tmp[[i]],
#                                                                     method = "spearman") %>%
#                                         tidy() %>%
#                                         mutate(im.cell = i, microbe = m, cancer = c))) 
#   
#   
# }
# 
# test <- lapply(cor.can, function(x) lapply(x, function (y) bind_rows(y)))
# test <- lapply(test, function(x) bind_rows(x))
# cor.can <- bind_rows(test)
# 
# write.csv(cor.can, "../../data/AACR_correlations.csv", row.names = F)

cor.can <- read.csv("../../data/AACR_correlations.csv")
```

# Build heatmaps

```{r triangle map}
cor.dat <- cor.can %>%
  select("estimate", "p.value", "microbe", "im.cell", "cancer") %>%
  # group_by(cancer) %>%
  # mutate(padj = p.adjust(p.value, method = "fdr")) %>%
  # ungroup() %>%
  filter(!is.na(estimate))
# cor.dat <- cor.dat[!duplicated(cor.dat),]

cor.dat %>%
  filter(cancer %in% c("CUT", "GU", "RCC")) %>%
  mutate(estimate = ifelse(p.value < 0.05, estimate, -2)) %>%
  ggplot(aes(x = microbe, y = im.cell, fill = estimate)) +
  facet_wrap(vars(cancer)) +
  geom_tile() +
  # geom_text(aes(label = ifelse(p.value < 0.05, "s", ""))) +
  scale_fill_distiller(guide = "legend", breaks = seq(-1,1,.2), 
                       limits = c(-1, 1), values = seq(0,1,.1),
                       type = "div", palette = "RdBu", direction = -1,
                       name = "Correlation",
                       na.value = "white") +
  labs(x = "", y = "") +
  scale_x_discrete(position = "top") +
  scale_y_discrete(breaks = oldlabs, labels = newlabs) +
  theme_bw() +
  theme(axis.text.x = element_blank()) +
  ggsave("../../figures/AACR/correlation-heatmap_toprow.png", width = 8, height = 3.5)

cor.dat %>%
  filter(!cancer %in% c("CUT", "GU", "RCC")) %>%
  mutate(estimate = ifelse(p.value < 0.05, estimate, -2)) %>%
  ggplot(aes(x = microbe, y = im.cell, fill = estimate)) +
  facet_wrap(vars(cancer)) +
  geom_tile() +
  # geom_text(aes(label = ifelse(p.value < 0.05, "s", ""))) +
  scale_fill_distiller(guide = "legend", breaks = seq(-.5,.5,.1), 
                       limits = c(-.5, .5), values = seq(0,1,.1),
                       type = "div", palette = "RdBu", direction = -1,
                       name = "Correlation",
                       na.value = "white") +
  labs(x = "", y = "") +
  scale_x_discrete(position = "top") +
  scale_y_discrete(breaks = oldlabs, labels = newlabs) +
  theme_bw() +
  theme(axis.text.x = element_blank()) +
  ggsave("../../figures/AACR/correlation-heatmap_bottomrow.png", width = 8, height = 3.5)
```