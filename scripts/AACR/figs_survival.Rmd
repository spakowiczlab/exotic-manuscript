---
title: "figures_correlations"
author: "Rebecca Hoyd"
date: "February 6, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(dplyr)
library(tidyr)
library(broom)
library(survival)
library(survminer)
library(Hmisc)
```

# Load data
```{r}
exo.ra <- read.csv("../../data/agg_exo-ra_taxonomy.csv", stringsAsFactors = F)
clindat <- read.csv("T:/Labs/Spakowicz/data/exoTCC/clinical_aggregated.csv", stringsAsFactors = F)

```


# Format for survival calculations

```{r}
exoRAtowideprev <- function(data, taxlev){
  tmp <- data
  tmp$Taxa <- tmp[[taxlev]]
  tmp.wide<- tmp %>%
    filter(!is.na(Taxa)) %>%
    mutate(Taxa = paste(taxlev, Taxa, sep = "_")) %>%
    group_by(sample, Taxa) %>%
    summarise(ra = sum(ra, na.rm = T)) %>%
    spread(key = "Taxa", value = "ra")
  
  tmp.wide[is.na(tmp.wide)] <- 0
  tmp.prev <- bind_rows(lapply(tmp.wide[,-1], function(x) ifelse(x > 0, 1, 0))) %>%
    mutate(sample = tmp.wide$sample) %>%
    select(sample, everything())
}
```

```{r}
taxalevels <- c("domain", "kingdom", "phylum", "class", "order", "family", "genus", "species")

exo.wide.list <- lapply(taxalevels, function(x) exoRAtowideprev(exo.ra, x))
names(exo.wide.list) <- taxalevels

microbes <- unlist(lapply(exo.wide.list, function(x) colnames(x)[-1]))

exo.wide <- bind_cols(exo.wide.list)

clindat <- clindat %>%
  rename("sample" = "RNA.SL.ID") %>%
  mutate(days = Overall.Survival.from.Dx..days.,
         vitalstatus = ifelse(Vital.Status == "Deceased", 1, 0))


loop.input <-clindat %>%
  left_join(exo.wide)

```

# Run surv ~ each microbe, in each cancer, at every taxa level

```{r}
cancers <- unique(loop.input$Cancer)
microbes <- make.names(microbes)
colnames(loop.input) <- make.names(colnames(loop.input))

canc.res <- list()
mic.res <- list()

for(c in cancers){
  loop.tmp <- loop.input %>%
    filter(Cancer == c)
  for(m in microbes){
    mic.res[[m]] <- coxph(formula = as.formula(paste0("Surv(days, vitalstatus) ~ ", m)), data = loop.tmp) %>%
      tidy() %>%
      mutate(hazard.ratio = exp(estimate),
             pvalue = p.value,
             taxa = m,
             cancer = c) %>%
      select(hazard.ratio, pvalue, taxa, cancer)
  }
  canc.res[[c]] <- mic.res
  mic.res <- list()
}

loop.output <- bind_rows(lapply(canc.res, function(x) bind_rows(x)))
```

# Create heatmap

```{r}
loop.output %>%
  separate(taxa, by = "_", into = c("Taxa.Level", "Taxa")) %>%
  ggplot(aes(x = Taxa, y = cancer, fill = pvalue)) +
  geom_tile() +
  facet_wrap(vars(fct_relevel(capitalize(Taxa.Level), capitalize(taxalevels))),
             scales = "free_x", ncol = 1) +
  labs(x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  ggsave("../../figures/AACR/survival-significance.png", height = 8)
```



