---
title: "Make Table 1: Cohort characteristics"
author: "Rebecca Hoyd"
date: "February 6, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tableone)
library(forcats)
library(glue)
library(readxl)
library(flextable)
library(officer)
```

# Load data
```{r}
# I'm storing these in my T drive as I suspect the may have identifiable information
clinfiles <- list.files("T:/Labs/Spakowicz/data/exoTCC/", full.names = F, "_Spakowicz")
clinfiles <- paste0("T:/Labs/Spakowicz/data/exoTCC/", clinfiles)

clindat <- lapply(clinfiles, function(x) read_excel(x, na = "N/A"))


```


# Coercing the clinical data into a tidier object
```{r}

for(i in 1:length(clindat)){
  # First, I don't want to have to deal with names poorly formatted for R. 
  colnames(clindat[[i]]) <- make.names(colnames(clindat[[i]]))
}

# Now, let's display the new column names and find the information needed for the table

lapply(clindat, function(x) colnames(x))
```

Drop the `Days.from...` columns that are being read in as both a numeric and character vector.

```{r}
for (i in 1:length(clindat)) {
  clindat[[i]] <- 
    clindat[[i]] %>%
    select(-contains("Days.from"))
}

lapply(clindat, function(x) colnames(x))
```

While the first two objects have similar naming schemes and information available, the second object may need to be handled separately.

```{r}
clindat.form1 <- bind_rows(clindat[[1]], clindat[[3]])
#   mutate(Days.from.RT.Start.to.Last.Follow.Up.or.Death = as.numeric(Days.from.RT.Start.to.Last.Follow.Up.or.Death),
#          Days.from.Hormone.Start.to.Last.Follow.Up.or.Death = as.numeric(Days.from.Hormone.Start.to.Last.Follow.Up.or.Death))

clindat.form2 <- clindat[[2]] %>%
  rename( "Cancer.Stage.at.Collection" = "Cancer.Stage.at.Collection..Best.CS.AJCC.") %>%
  select(colnames(clindat.form1))

clindat.form <- bind_rows(clindat.form1, clindat.form2)

```

```{r, eval=F}
write.csv(clindat.form, paste0("T:/Labs/Spakowicz/data/exoTCC/", Sys.Date(), "_clinical_aggregated.csv"), row.names = F)
```

# Format  for the table

```{r learn about condensing variables}
clindat.form %>%
  mutate(Chemo.Drug.Name = tolower(Chemo.Drug.Name)) %>%
  separate(Chemo.Drug.Name, into = c('testChem')) %>%
  group_by(testChem) %>%
  tally() %>%
  arrange(desc(n))

clindat.form %>%
  mutate(I.O.Drug.Name = tolower(I.O.Drug.Name)) %>%
  separate(I.O.Drug.Name, into = c('testIO')) %>%
  group_by(testIO) %>%
  tally() %>%
  arrange(desc(n))
```

```{r}

# Select and adjust dataframe for Table 1
clindat.tabnames <- clindat.form %>%
  mutate(Stage  = ifelse(Cancer.Stage.at.Collection %in% c("88", "99", "undeterm.") , 
                         "Unknown", Cancer.Stage.at.Collection),
         BMI = BMI.at.Collection,
         Age = Age.at.Collection,
         Sex = Gender,
         `Vital Status` = Vital.Status,
         IO = ifelse(I.O.Drug.Name == "N/A", "None", 
                     ifelse(grepl("pembro", I.O.Drug.Name, ignore.case = T), "Pembrolizumab", 
                            ifelse(grepl("nivo", I.O.Drug.Name, ignore.case = T), "Nivolumab",
                                   ifelse(grepl("beva", I.O.Drug.Name, ignore.case = T), "Bevacizumab",
                                          ifelse(grepl("folfiri", I.O.Drug.Name, ignore.case = T), "Folfiri",
                                                 ifelse(grepl("ipili", I.O.Drug.Name, ignore.case = T),
                                                        "Ipilimumab",ifelse(grepl("unknown", Chemo.Drug.Name,
                                                                                  ignore.case = T), 
                                                                            "Unknown", "Other"))))))),
         Chemotherapy = ifelse(Chemo.Drug.Name == "N/A", "none",
                               ifelse(grepl("cisp", Chemo.Drug.Name, ignore.case = T), "Cisplatin",
                                      ifelse(grepl("carb", Chemo.Drug.Name, ignore.case = T), "Carboplatin",
                                             ifelse(grepl("folfox", Chemo.Drug.Name, ignore.case = T), "Folfox",
                                                    ifelse(grepl("doxo", Chemo.Drug.Name, ignore.case = T),
                                                           "Doxorubicin",
                                                           ifelse(grepl("adria", Chemo.Drug.Name, ignore.case = T),
                                                                  "Adriamycin", 
                                                                  ifelse(grepl("unknown", Chemo.Drug.Name,
                                                                               ignore.case = T), "Unknown",
                                                                         "Other"))))))
         ),
         Radiation = ifelse(Radiation == "None", "No", "Yes"),
         Surgery = ifelse(grepl("None", Surgery), "No", "Yes"),
         Hormones = ifelse(is.na(Hormone.Therapy), "No", "Yes")
  )
```

# Creating table 1

```{r}
listVars <- c("BMI", "Age", "Sex", "Cancer", "Stage", "Vital Status", "IO", "Chemotherapy",
              "Radiation", "Surgery", "Hormones")
catVars <- c("Sex", "Cancer", "Stage", "Vital Status", "IO", "Chemotherapy", "Radiation", "Surgery", "Hormones")
```

```{r table 1}
table1 <- CreateTableOne(vars = listVars,
                         data = clindat.tabnames,
                         factorVars = catVars)
table1
```

```{r}
tabMat <- print(table1, quote = FALSE, noSpaces = TRUE, printToggle = FALSE)
## Save to a CSV file
write.csv(tabMat, file = "../../figures/AACR/table1.csv")
```

# Version 2

```{r}
getstages <- clindat.form %>%
  mutate(Cancer.Stage.at.Collection = ifelse(Cancer.Stage.at.Collection %in% c("88", "99", "undeterm."), 
                         "Unknown", Cancer.Stage.at.Collection),
         Cancer.Stage.at.Collection = paste0("Stage.", Cancer.Stage.at.Collection)) %>%
  group_by(Cancer, Cancer.Stage.at.Collection) %>%
  tally() %>%
  spread(key = "Cancer.Stage.at.Collection", value = "n")

getreatment <- clindat[[2]] %>%
  select(RNA.SL.ID, X.Treatment.) %>%
  left_join(clindat.form, .) %>%
  mutate(Chemo.given = ifelse(grepl("chemo", X.Treatment.), 1, 
                              ifelse(Chemo.Drug.Name != "N/A" & Chemo.Drug.Name != "N", 1, 0)),
         IO.given = ifelse(!is.na(I.O.Drug.Name), 1, 0),
         Targeted.given = ifelse(X.Treatment. == "targeted", 1, 0)) %>%
  group_by(Cancer) %>%
  summarise(given.Chemo = sum(Chemo.given),
            given.IO = sum(IO.given),
            given.Targeted = sum(Targeted.given, na.rm = T))

tabMat.v2 <- clindat.form %>%
  mutate(percent.male = ifelse(Gender == "Male", 1, 0),
         patnum = 1) %>%
  group_by(Cancer) %>%
  summarise(dem.Percent.Male = round(mean(percent.male), 2),
            avg.age = mean(Age.at.Collection),
            std.age = sqrt(var(Age.at.Collection)),
            avg.bmi = mean(BMI.at.Collection),
            std.bmi = sqrt(var(BMI.at.Collection)),
            dem.Total.n = sum(patnum)) %>%
  mutate(dem.Age = paste0(round(avg.age), " (", round(std.age, 2), ")"),
         dem.BMI = paste0(round(avg.bmi), " (", round(std.bmi, 2), ")")) %>%
  select(Cancer, dem.Age, dem.BMI, dem.Total.n, dem.Percent.Male) %>%
  left_join(getstages) %>%
  left_join(getreatment)
```

```{r table formatting}
tab1.flextab <- tabMat.v2 %>%
  gather(-Cancer, key = "Measurement", value = "Result") %>%
  mutate(Result = ifelse(is.na(Result), 0, Result),
         Measure.type = ifelse(grepl("Stage", Measurement), "Stage",
                               ifelse(grepl("given", Measurement), "Treatment Type",
                                      "Demographic"))) %>%
  spread(key = "Cancer", value = "Result") %>%
  select(Measure.type, Measurement, everything()) %>%
  mutate(Measurement = fct_relevel(Measurement, "Total.n", "Age", "BMI", "Targeted.given")) %>%
  flextable() %>%
  merge_v("Measure.type") %>%
  theme_vanilla() 
```

```{r}
doc <- read_docx()
doc <- body_add_flextable(doc, value = tab1.flextab)
print(doc, target = "../../figures/AACR/tab1.docx")
```


# Table 2 - analysis summary

## Load data : 
```{r}
cor.can <- read.csv("../../data/AACR_correlations.csv", stringsAsFactors = F) %>%
  separate(microbe, by = "_", into = c("Taxa.Level", "Taxa"), extra = "merge")%>%
  mutate(Taxa = gsub(" ", ".", Taxa))
surv.can <- read.csv("../../data/survival-microbe-output.csv", stringsAsFactors = F)%>%
  separate(taxa, by = "_", into = c("Taxa.Level", "Taxa"), extra = "merge")
cor.gene <- read.csv("../../data/corr_microbes-with-genes.csv", stringsAsFactors = F) %>%
  mutate(Taxa = gsub(" ", ".", Taxa))

```

## Create table

```{r}

tab2.cancers <- cor.can %>%
  filter(im.cell == "TILs") %>%
  left_join(surv.can) %>%
  group_by(Taxa.Level, Taxa) %>%
  summarise(Survival.significant = ifelse(any(pvalue < 0.05),1, 0),
            Immune.correlation = ifelse(any(p.value < 0.05),1, 0))

tab2.genes <- cor.gene %>%
  filter(Var1 %in% c("DDX58", "MB21D1") & !is.na(Taxa)) %>%
  mutate(gene.sig = ifelse(fdr < 0.05, 1, 0)) %>%
  group_by(Taxa.Level, Taxa, Var1) %>%
  mutate(gene.sig = ifelse(sum(gene.sig) > 0, 1, 0)) %>%
  select(Taxa.Level, Taxa, Var1, gene.sig) %>%
  spread(key = "Var1", value = "gene.sig")

tab2.all <- tab2.cancers %>%
  left_join(tab2.genes) %>%
  select(Taxa.Level, Taxa, DDX58 , MB21D1 , Survival.significant , Immune.correlation) 

tab2.all[, -c(1,2)] <- bind_rows(lapply(tab2.all[,-c(1,2)], function(x) ifelse(is.na(x), 0, x)))

tab2.all$times.sig <- rowSums(tab2.all[, -c(1,2)])

tab2.all %>%
  arrange(desc(times.sig)) %>%
  write.csv("../../data/summarize-analyses-AACR.csv", row.names = F)
```

